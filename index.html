<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://esm.sh; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net data:; img-src 'self' data: https:; connect-src 'self' https://*.supabase.co wss://*.supabase.co https://lrclib.net https://api.lyrics.ovh https://api.mymemory.translated.net https://api.dictionaryapi.dev https://yt.lemnoslife.com https://www.youtube.com https://www.youtube-nocookie.com https://piped.video https://itunes.apple.com; frame-src https://www.youtube.com https://www.youtube-nocookie.com https://piped.video https://open.spotify.com; object-src 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), payment=()">
    <title>Icarus Type</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- OpenDyslexic Font -->
    <link href="https://cdn.jsdelivr.net/npm/opendyslexic@2.1.0/open-dyslexic.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles/themes.css">
</head>
<body class="h-screen flex flex-col items-center">

    <input type="text" id="typing-input" class="hidden-input" autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false">
    <div id="toast-container"></div>

    <!-- Word Menu Popover -->
    <div id="popover-overlay" class="fixed inset-0 z-40 hidden" data-onclick="closeWordPopover()"></div>
    <div id="word-popover" class="word-popover">
        <div class="popover-header">
            <h4 id="popover-word-title" class="text-main font-bold capitalize">Word</h4>
            <div class="flex gap-2 items-center">
                <button id="popover-speak-btn" data-onclick="speakWord(document.getElementById('popover-word-title').textContent)" class="text-sub hover:text-base" title="Listen">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                </button>
                <button id="popover-save-btn" data-onclick="toggleSavedWord()" class="text-sub hover:text-error" title="Save to Vocabulary">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                </button>
            </div>
        </div>
        <div class="popover-actions">
            <div id="btn-def" class="popover-btn hover:opacity-80" data-onclick="showDefinition()">Meaning</div>
            <div id="btn-trans" class="popover-btn hover:opacity-80" data-onclick="showTranslation()">Translation</div>
        </div>
        <div id="popover-content" class="popover-body">
            <span class="text-sub text-xs italic">Loading...</span>
        </div>
    </div>

    <!-- Onboarding, Profile, About, Settings, Practice Modals (No Changes) -->
    <!-- Onboarding Modal -->
    <div id="onboarding-overlay" class="fixed inset-0 z-50 hidden flex justify-center items-center fade-in">
        <div class="bg-surface p-8 rounded-lg shadow-2xl max-w-lg w-full mx-4 border border-main">
            <h3 class="text-main font-bold text-2xl mb-4 text-center">Welcome to Icarus Type!</h3>
            <div class="text-base text-sm space-y-4 mb-6">
                <p>Improve your English typing and vocabulary through music.</p>
                <ul class="list-disc list-inside space-y-2 text-sub">
                    <li><strong class="text-main">Type Lyrics:</strong> Find your favorite songs or use your saved favorites.</li>
                    <li><strong class="text-main">Modes:</strong> 
                        <ul class="pl-6 mt-1 text-xs">
                            <li><strong>Normal:</strong> Type along with the lyrics.</li>
                            <li><strong>Cloze:</strong> Guess missing words for memory practice.</li>
                        </ul>
                    </li>
                    <li><strong class="text-main">Tools:</strong> Use <span class="text-main">Ctrl</span> to speak words and <span class="text-main">Alt</span> to free look.</li>
                    <li><strong class="text-main">Progress:</strong> Earn XP and badges as you type.</li>
                </ul>
            </div>
            <div class="text-center">
                <button data-onclick="closeOnboarding()" class="btn-primary px-8 py-2 rounded font-bold transition">Let's Rock</button>
            </div>
        </div>
    </div>

    <!-- Account Modal -->
    <div id="profile-modal-overlay" class="fixed inset-0 z-50 hidden flex justify-center items-center fade-in" data-onclick="if(event.target === this) closeModal('profile')">
        <div class="bg-surface p-8 rounded-lg shadow-2xl max-w-md w-full mx-4 border border-sub max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-main font-bold text-xl">Account</h3>
                <button data-onclick="closeModal('profile')" class="text-sub hover:text-base text-sm">Close</button>
            </div>

            <div id="auth-guest-view">
                <div class="auth-tabs mb-4">
                    <button id="auth-tab-login" class="auth-tab active" data-onclick="switchAuthTab('login')">Login</button>
                    <button id="auth-tab-register" class="auth-tab" data-onclick="switchAuthTab('register')">Register</button>
                </div>

                <div id="auth-login-form" class="auth-panel">
                    <div class="auth-social-grid">
                        <button class="auth-social-btn" disabled title="Coming soon">Google (soon)</button>
                        <button class="auth-social-btn" disabled title="Coming soon">GitHub (soon)</button>
                    </div>
                    <div class="auth-divider"><span>or</span></div>
                    <div class="auth-field-group">
                        <label class="auth-label" for="auth-login-email">Email or username</label>
                        <input id="auth-login-email" type="text" class="auth-input" placeholder="you@example.com or username" autocomplete="username">
                    </div>
                    <div class="auth-field-group">
                        <label class="auth-label" for="auth-login-password">Password</label>
                        <div class="auth-password-wrap">
                            <input id="auth-login-password" type="password" class="auth-input auth-input-with-toggle" placeholder="Your password" autocomplete="current-password">
                            <button type="button" class="auth-password-toggle" data-onclick="togglePasswordVisibility('auth-login-password', this)" aria-label="Show password" aria-pressed="false">Show</button>
                        </div>
                    </div>
                    <label class="auth-checkbox-row">
                        <input id="auth-remember-me" type="checkbox">
                        <span>Remember me</span>
                    </label>
                    <button class="auth-submit-btn mt-4" data-onclick="loginAccount()">Sign in</button>
                </div>

                <div id="auth-register-form" class="auth-panel hidden">
                    <div class="auth-field-group">
                        <label class="auth-label" for="auth-register-username">Username</label>
                        <input id="auth-register-username" type="text" class="auth-input" placeholder="username" autocomplete="username">
                    </div>
                    <div class="auth-field-group">
                        <label class="auth-label" for="auth-register-email">Email</label>
                        <input id="auth-register-email" type="email" class="auth-input" placeholder="you@example.com" autocomplete="email">
                    </div>
                    <div class="auth-field-group">
                        <label class="auth-label" for="auth-register-email-verify">Verify email</label>
                        <input id="auth-register-email-verify" type="email" class="auth-input" placeholder="repeat email" autocomplete="email">
                    </div>
                    <div class="auth-field-group">
                        <label class="auth-label" for="auth-register-password">Password</label>
                        <div class="auth-password-wrap">
                            <input id="auth-register-password" type="password" class="auth-input auth-input-with-toggle" placeholder="Choose a password" autocomplete="new-password">
                            <button type="button" class="auth-password-toggle" data-onclick="togglePasswordVisibility('auth-register-password', this)" aria-label="Show password" aria-pressed="false">Show</button>
                        </div>
                    </div>
                    <div class="auth-field-group">
                        <label class="auth-label" for="auth-register-password-verify">Verify password</label>
                        <div class="auth-password-wrap">
                            <input id="auth-register-password-verify" type="password" class="auth-input auth-input-with-toggle" placeholder="repeat password" autocomplete="new-password">
                            <button type="button" class="auth-password-toggle" data-onclick="togglePasswordVisibility('auth-register-password-verify', this)" aria-label="Show password" aria-pressed="false">Show</button>
                        </div>
                    </div>
                    <button class="auth-submit-btn mt-4" data-onclick="registerAccount()">Sign up</button>
                </div>
            </div>

            <div id="auth-user-view" class="hidden">
                <div class="auth-user-card">
                    <div class="auth-profile-edit-row">
                        <button class="auth-friend-btn" data-onclick="openProfileHub()">
                            Open profile
                        </button>
                        <button class="auth-friend-btn" data-onclick="toggleProfileEditor()">
                            Edit profile
                        </button>
                    </div>
                    <div class="auth-profile-top">
                        <img id="auth-user-avatar" class="auth-avatar auth-avatar-clickable" src="https://placehold.co/80x80/0B2D45/3EE39E?text=IT" alt="avatar" data-onclick="openAvatarPreview()">
                        <div>
                            <div class="text-sub text-xs uppercase mb-1">Logged in as</div>
                            <div id="auth-user-name" class="text-main font-bold text-lg">username</div>
                            <div id="auth-user-email" class="text-base text-sm">email@example.com</div>
                            <div id="auth-user-level" class="auth-level mt-1">Level 1</div>
                        </div>
                    </div>
                    <div id="auth-profile-edit-panel" class="auth-profile-edit-panel hidden">
                        <div class="auth-field-group">
                            <label class="auth-label" for="auth-avatar-file">Upload avatar</label>
                            <input id="auth-avatar-file" type="file" class="auth-file-input" accept="image/*">
                            <div class="auth-file-row">
                                <button class="auth-file-trigger" data-onclick="triggerAvatarPicker()">Choose file</button>
                                <span id="auth-avatar-file-name" class="auth-file-name">No file selected</span>
                            </div>
                        </div>
                        <div class="auth-field-group">
                            <label class="auth-label" for="auth-user-bio">Bio</label>
                            <textarea id="auth-user-bio" class="auth-input auth-bio-input" rows="2" maxlength="180" placeholder="Tell people about your music taste..."></textarea>
                        </div>
                        <div class="auth-field-group">
                            <label class="auth-label">Preferred player</label>
                            <div id="auth-player-pref" class="auth-player-pref" role="radiogroup" aria-label="Preferred music player">
                                <button type="button" class="auth-player-btn active" data-player="spotify" aria-pressed="true">Spotify</button>
                                <button type="button" class="auth-player-btn" data-player="deezer" aria-pressed="false">Deezer</button>
                                <button type="button" class="auth-player-btn" data-player="youtube_music" aria-pressed="false">YouTube Music</button>
                            </div>
                        </div>
                        <div class="auth-edit-actions">
                            <button class="auth-submit-btn" data-onclick="saveProfileDetails()">Save profile</button>
                            <button class="auth-friend-btn" data-onclick="toggleProfileEditor(false)">Cancel</button>
                        </div>
                    </div>
                    <div id="auth-achievements" class="auth-achievements mt-2">
                        <div class="auth-recent-empty">No achievements yet.</div>
                    </div>
                </div>

                <div id="auth-nonedit-sections">
                <div id="auth-stats-section" class="auth-stats-grid mt-4">
                    <div class="auth-stat-box">
                        <div class="auth-stat-label">Games</div>
                        <div id="auth-stat-games" class="auth-stat-value">0</div>
                    </div>
                    <div class="auth-stat-box">
                        <div class="auth-stat-label">Best WPM</div>
                        <div id="auth-stat-best-wpm" class="auth-stat-value">0</div>
                    </div>
                    <div class="auth-stat-box">
                        <div class="auth-stat-label">Avg WPM</div>
                        <div id="auth-stat-avg-wpm" class="auth-stat-value">0</div>
                    </div>
                    <div class="auth-stat-box">
                        <div class="auth-stat-label">Avg Acc</div>
                        <div id="auth-stat-avg-acc" class="auth-stat-value">0%</div>
                    </div>
                </div>

                <div id="auth-recent-section" class="mt-4">
                    <div class="text-sub text-xs uppercase mb-2">Recent results</div>
                    <div id="auth-recent-results" class="auth-recent-list">
                        <div class="auth-recent-empty">No saved games yet.</div>
                    </div>
                </div>

                <div id="auth-history-section" class="mt-4">
                    <div class="text-sub text-xs uppercase mb-2">Song history</div>
                    <div class="auth-history-wrap">
                        <select id="auth-history-song" class="auth-input">
                            <option value="">Select a song</option>
                        </select>
                        <canvas id="auth-history-chart" height="120"></canvas>
                        <div id="auth-history-summary" class="auth-history-summary">Finish more tests to see detailed history by song.</div>
                    </div>
                </div>

                <div id="auth-friends-section" class="mt-4">
                    <div class="text-sub text-xs uppercase mb-2">Friends</div>
                    <div class="auth-friends-wrap">
                        <div class="auth-friend-add-row">
                            <input id="auth-friend-username" type="text" class="auth-input" placeholder="friend email or username">
                            <button class="auth-submit-btn" data-onclick="sendFriendRequest()">Add</button>
                        </div>
                        <div class="auth-subtitle">Requests</div>
                        <div id="auth-friend-requests" class="auth-friend-list">
                            <div class="auth-recent-empty">No requests.</div>
                        </div>
                        <div class="auth-subtitle">Compare</div>
                        <div id="auth-friend-compare" class="auth-friend-list">
                            <div class="auth-recent-empty">No friends added yet.</div>
                        </div>
                    </div>
                </div>

                <div id="auth-duel-section" class="mt-4">
                    <div class="text-sub text-xs uppercase mb-2">Duel rooms</div>
                    <div class="auth-friends-wrap">
                        <div class="auth-friend-add-row">
                            <button class="auth-submit-btn" data-onclick="createDuelRoomFromCurrentSong()">Create room from current song</button>
                        </div>
                        <div class="auth-friend-add-row mt-2">
                            <input id="duel-room-code-input" type="text" class="auth-input" placeholder="room id (uuid)">
                            <button class="auth-submit-btn" data-onclick="joinDuelRoomByCode()">Join</button>
                        </div>
                        <div id="duel-room-box" class="duel-room-box mt-2 hidden">
                            <div id="duel-room-meta" class="duel-room-meta">Room: -</div>
                            <div id="duel-room-status" class="duel-room-status">Status: waiting</div>
                            <div class="auth-friend-add-row mt-2">
                                <input id="duel-invite-target" type="text" class="auth-input" placeholder="friend username/email">
                                <button class="auth-submit-btn" data-onclick="invitePlayerToDuelRoom()">Invite</button>
                            </div>
                            <div class="auth-friend-add-row mt-2">
                                <button class="auth-submit-btn" data-onclick="startDuelCountdown()">Start duel</button>
                                <button class="auth-friend-btn reject" data-onclick="leaveCurrentDuelRoom()">Leave</button>
                            </div>
                            <div class="auth-subtitle mt-3">Room players</div>
                            <div id="duel-room-members" class="auth-friend-list">
                                <div class="auth-recent-empty">No players.</div>
                            </div>
                        </div>
                        <div class="auth-subtitle mt-3">Invite from friends list</div>
                        <div id="duel-friend-list" class="auth-friend-list">
                            <div class="auth-recent-empty">No friends added yet.</div>
                        </div>
                        <div class="auth-subtitle mt-3">Incoming duel invites</div>
                        <div id="duel-invite-list" class="auth-friend-list">
                            <div class="auth-recent-empty">No duel invites.</div>
                        </div>
                    </div>
                </div>

                <div id="auth-favorites-section" class="mt-4">
                    <div class="text-sub text-xs uppercase mb-2">Favorites playlist</div>
                    <div class="auth-favorites-wrap">
                        <button class="auth-submit-btn" data-onclick="addCurrentSongToFavorites()">Add current song</button>
                        <div id="auth-favorites-list" class="auth-favorite-list">
                            <div class="auth-recent-empty">No favorites yet.</div>
                        </div>
                    </div>
                </div>

                <div id="auth-danger-section" class="auth-field-group mt-4">
                    <label class="auth-label" for="auth-delete-password">Confirm password to delete account</label>
                    <input id="auth-delete-password" type="password" class="auth-input" placeholder="Current password" autocomplete="current-password">
                </div>

                <div id="auth-actions-section" class="auth-actions mt-6">
                    <button class="auth-submit-btn" data-onclick="logoutAccount()">Logout</button>
                    <button class="auth-delete-btn" data-onclick="deleteAccount()">Delete account</button>
                </div>
                </div>
            </div>
        </div>
    </div>

    <div id="profile-hub-overlay" class="fixed inset-0 z-50 hidden fade-in profile-hub-overlay" data-onclick="if(event.target === this) closeProfileHub()">
        <div class="profile-hub-shell">
            <div class="profile-hub-header">
                <div>
                    <div class="profile-hub-kicker">Icarus Profile</div>
                    <h2 id="profile-hub-name" class="profile-hub-title">username</h2>
                </div>
                <button class="auth-friend-btn" data-onclick="closeProfileHub()">Close</button>
            </div>

            <div class="profile-hub-hero">
                <img id="profile-hub-avatar" class="profile-hub-avatar auth-avatar-clickable" src="https://placehold.co/96x96/0B2D45/3EE39E?text=IT" alt="avatar" data-onclick="openProfileHubAvatarPreview()">
                <div class="profile-hub-meta">
                    <div id="profile-hub-level" class="profile-hub-level">Level 1</div>
                    <div id="profile-hub-email" class="profile-hub-email">email@example.com</div>
                    <p id="profile-hub-bio" class="profile-hub-bio">No bio yet.</p>
                </div>
            </div>

            <div class="profile-hub-stats-grid">
                <div class="profile-hub-stat"><span>Games</span><strong id="profile-hub-games">0</strong></div>
                <div class="profile-hub-stat"><span>Best WPM</span><strong id="profile-hub-best">0</strong></div>
                <div class="profile-hub-stat"><span>Avg WPM</span><strong id="profile-hub-avgwpm">0</strong></div>
                <div class="profile-hub-stat"><span>Avg Acc</span><strong id="profile-hub-avgacc">0%</strong></div>
            </div>

            <section class="profile-hub-compare">
                <div class="profile-hub-compare-head">
                    <h3>Compare With Friend</h3>
                    <select id="profile-hub-compare-select" class="auth-input profile-hub-compare-select">
                        <option value="">Select a friend</option>
                    </select>
                </div>
                <div id="profile-hub-compare-grid" class="profile-hub-compare-grid">
                    <div class="auth-recent-empty">Select a friend to compare stats in this panel.</div>
                </div>
            </section>

            <div class="profile-hub-main-grid">
                <section class="profile-hub-card">
                    <h3>Performance</h3>
                    <canvas id="profile-hub-chart" height="140"></canvas>
                </section>
                <section class="profile-hub-card">
                    <h3>Achievements</h3>
                    <div id="profile-hub-achievements" class="profile-hub-achievements">
                        <div class="auth-recent-empty">No achievements yet.</div>
                    </div>
                </section>
                <section class="profile-hub-card">
                    <h3>Recent Results</h3>
                    <div id="profile-hub-recent" class="profile-hub-list">
                        <div class="auth-recent-empty">No saved games yet.</div>
                    </div>
                </section>
                <section class="profile-hub-card">
                    <h3>Favorite Playlist</h3>
                    <div id="profile-hub-favorites" class="profile-hub-list">
                        <div class="auth-recent-empty">No favorites yet.</div>
                    </div>
                </section>
                <section class="profile-hub-card profile-hub-card-wide">
                    <h3>Friends Comparison</h3>
                    <div id="profile-hub-friends" class="profile-hub-list">
                        <div class="auth-recent-empty">No friends added yet.</div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Modals (Others) -->
    <div id="modal-overlay" class="fixed inset-0 z-50 hidden flex justify-center items-center fade-in">
        <div class="bg-surface p-8 rounded-lg shadow-2xl max-w-sm w-full mx-4 text-center border border-sub">
            <h3 class="text-main font-bold text-xl mb-2">Cancel Search?</h3>
            <p class="text-sub text-sm mb-6">Stop searching for lyrics?</p>
            <div class="flex justify-center gap-4">
                <button data-onclick="cancelNavigation()" class="text-base hover:text-main transition text-sm">No</button>
                <button data-onclick="confirmNavigation()" class="btn-primary px-4 py-1 rounded transition text-sm">Yes</button>
            </div>
        </div>
    </div>

    <div id="restart-modal-overlay" class="fixed inset-0 z-50 hidden flex justify-center items-center fade-in">
        <div class="bg-surface p-8 rounded-lg shadow-2xl max-w-sm w-full mx-4 text-center border border-sub">
            <h3 class="text-main font-bold text-xl mb-2">Restart?</h3>
            <p class="text-base text-sm mb-6">Your current progress will be lost.</p>
            <div class="flex justify-center gap-4">
                <button data-onclick="cancelRestart()" class="text-base hover:text-main transition text-sm">Resume</button>
                <button data-onclick="confirmRestart()" class="btn-primary px-6 py-1 rounded font-bold transition text-sm">Restart</button>
            </div>
        </div>
    </div>

    <div id="about-modal-overlay" class="fixed inset-0 z-50 hidden flex justify-center items-center fade-in" data-onclick="if(event.target === this) closeModal('about')">
        <div class="bg-surface p-8 rounded-lg shadow-2xl max-w-md w-full mx-4 text-center border border-sub">
            <h3 class="text-main font-bold text-2xl mb-4">About Icarus Type</h3>
            <div class="text-base text-sm space-y-4 text-left">
                <p>Icarus Type is a minimalist typing practice tool designed to help you learn English through music.</p>
                <div class="pt-4 border-t border-sub">
                    <p class="text-xs text-sub mb-1">Powered by:</p>
                    <ul class="list-disc list-inside text-xs text-main">
                        <li>LrcLib.net (Lyrics)</li>
                        <li>Lyrics.ovh (Backup)</li>
                        <li>MyMemory (Translation)</li>
                    </ul>
                </div>
            </div>
            <button data-onclick="closeModal('about')" class="mt-6 text-sub hover:text-base text-sm">Close</button>
        </div>
    </div>

    <div id="settings-modal-overlay" class="fixed inset-0 z-50 hidden flex justify-center items-center fade-in" data-onclick="if(event.target === this) closeModal('settings')">
        <div class="bg-surface p-8 rounded-lg shadow-2xl max-w-md w-full mx-4 border border-sub">
            <h3 class="text-main font-bold text-xl mb-6 text-center">Settings</h3>
            
            <div class="space-y-6">
                <!-- Toggles -->
                <div>
                    <p class="text-xs text-sub uppercase font-bold mb-3">Gameplay</p>
                    <div class="flex justify-between items-center pb-2 border-b border-sub border-opacity-30">
                        <span class="text-base text-sm">Easy Mode (Translation)</span>
                        <button data-onclick="toggleEasyMode(); closeModal('settings')" class="text-main hover:text-base text-xs uppercase font-bold">Toggle</button>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-b border-sub border-opacity-30 pb-2">
                        <span class="text-base text-sm">Auto-Speak Words</span>
                        <button data-onclick="toggleAutoSpeak(); closeModal('settings')" class="text-main hover:text-base text-xs uppercase font-bold">Toggle</button>
                    </div>
                    <div class="flex justify-between items-center pt-2">
                        <span class="text-base text-sm">Sound FX</span>
                        <button id="btn-toggle-sound" data-onclick="toggleSound();" class="text-main hover:text-base text-xs uppercase font-bold">OFF</button>
                    </div>
                    <div class="flex justify-between items-center pt-2">
                        <span class="text-base text-sm">Dyslexic Font</span>
                        <button id="btn-toggle-dyslexic" data-onclick="toggleDyslexicMode();" class="text-main hover:text-base text-xs uppercase font-bold">OFF</button>
                    </div>
                </div>

                <!-- Themes -->
                <div>
                    <p class="text-xs text-sub uppercase font-bold mb-3">Theme</p>
                    <div class="theme-grid" id="theme-selector">
                        <!-- Injected by JS -->
                    </div>
                </div>

                <!-- Shortcuts -->
                <div>
                    <p class="text-xs text-sub uppercase font-bold mb-3">Shortcuts</p>
                    <div class="grid grid-cols-2 gap-2 text-sm text-base">
                        <div><kbd class="bg-surface border border-sub px-1 rounded text-sub">Tab</kbd> Restart</div>
                        <div><kbd class="bg-surface border border-sub px-1 rounded text-sub">Ctrl</kbd> Speak</div>
                        <div><kbd class="bg-surface border border-sub px-1 rounded text-sub">Alt</kbd> Free Look</div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-6">
                <button data-onclick="closeModal('settings')" class="text-sub hover:text-base text-sm">Close</button>
            </div>
        </div>
    </div>

    <div id="practice-modal-overlay" class="fixed inset-0 z-50 hidden flex justify-center items-center fade-in">
        <div class="bg-surface p-8 rounded-lg shadow-2xl max-w-lg w-full mx-4 border border-sub min-h-[400px] flex flex-col items-center justify-center relative">
            <button data-onclick="closeModal('practice')" class="absolute top-4 right-4 text-sub hover:text-base">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <h3 class="text-main font-bold text-xl mb-8">Practice Tricky Words</h3>
            <div id="practice-container" class="w-full flex flex-col items-center"></div>
            <div id="practice-progress" class="practice-progress mt-8">0 / 0</div>
        </div>
    </div>

    <!-- Header -->
    <header class="w-full max-w-6xl px-4 py-5 sm:p-8 flex flex-col sm:flex-row sm:justify-between sm:items-end items-start gap-4 mb-3 sm:mb-4">
        <div id="header-brand" class="header-brand flex items-center gap-3 cursor-pointer select-none" data-onclick="goHome()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-main" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
            <div class="flex flex-col leading-none">
                <h1 class="text-2xl font-bold text-base">Icarus <span class="text-main">Type</span></h1>
                <span class="text-[10px] text-sub tracking-widest">learn english with music</span>
            </div>
        </div>
        <div class="header-actions flex justify-start sm:justify-end items-center gap-3 sm:gap-4 text-sub flex-nowrap pb-1 sm:pb-0">
            <button data-onclick="goHome()" class="btn-ghost transition" title="Home"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2" ry="2"></rect><path d="M6 8h.001"></path><path d="M10 8h.001"></path><path d="M14 8h.001"></path><path d="M18 8h.001"></path><path d="M6 12h.001"></path><path d="M10 12h.001"></path><path d="M14 12h.001"></path><path d="M18 12h.001"></path><path d="M7 16h10"></path></svg></button>
            <button data-onclick="openProfileScreen()" class="btn-ghost transition" title="Full profile"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></button>
            <button data-onclick="openModal('about')" class="btn-ghost transition" title="About"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg></button>
            <button data-onclick="openModal('settings')" class="btn-ghost transition" title="Settings"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33h.01a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.01a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.01a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
            <button id="header-avatar-button" data-onclick="handleHeaderAvatarClick(event)" class="header-avatar-btn transition" title="Friends/account (Shift or Ctrl click to zoom)">
                <img id="header-avatar-image" class="header-avatar-image" src="https://placehold.co/80x80/0B2D45/3EE39E?text=IT" alt="account avatar">
            </button>
        </div>
    </header>

    <div class="w-full max-w-4xl flex justify-start sm:justify-center mb-4 sm:mb-8 px-2 sm:px-0">
        <div class="config-bar mobile-config-bar">
                <div class="mode-group">
                    <div class="nav-link active" id="nav-search" data-onclick="trySwitchTab('search')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>search</div>
                    <div class="nav-link" id="nav-presets" data-onclick="trySwitchTab('presets')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>favorites</div>
                    <div class="nav-link" id="nav-custom" data-onclick="trySwitchTab('custom')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>custom</div>
                    <div class="nav-link" id="nav-duel" data-onclick="trySwitchTab('duel')"><svg class="nav-icon" viewBox="0 0 24 24"><path d="M8 4l-3 8h5l-2 8 11-13h-6l2-3z"/></svg>duel</div>
                </div>
            <div class="separator"></div>
            <div class="mode-group">
                <div class="nav-link active" id="mode-normal" data-onclick="setGameMode('normal')">normal</div>
                <div class="nav-link" id="mode-cloze" data-onclick="setGameMode('cloze')">cloze</div>
                <div class="nav-link" id="mode-rhythm" data-onclick="setGameMode('rhythm')">rhythm</div>
            </div>
        </div>
    </div>

    <div id="artist-songs-modal-overlay" class="fixed inset-0 z-50 hidden flex justify-center items-center fade-in" data-onclick="if(event.target === this) closeArtistSongsModal()">
        <div class="bg-surface p-6 rounded-lg shadow-2xl max-w-2xl w-full mx-4 border border-sub max-h-[88vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 id="artist-songs-title" class="text-main font-bold text-xl">Artist songs</h3>
                <button data-onclick="closeArtistSongsModal()" class="text-sub hover:text-base text-sm">Close</button>
            </div>
            <div id="artist-songs-status" class="text-sub text-sm mb-3">Type an artist name and click browse.</div>
            <div id="artist-songs-list" class="artist-songs-list">
                <div class="auth-recent-empty">No songs loaded.</div>
            </div>
        </div>
    </div>

    <div id="avatar-preview-overlay" class="fixed inset-0 z-50 hidden flex items-center justify-center fade-in avatar-preview-overlay" data-onclick="if(event.target === this) closeAvatarPreview()">
        <div class="avatar-preview-card">
            <button data-onclick="closeAvatarPreview()" class="avatar-preview-close">Close</button>
            <img id="avatar-preview-image" class="avatar-preview-image" src="https://placehold.co/320x320/0B2D45/3EE39E?text=IT" alt="Avatar preview">
            <div id="avatar-preview-name" class="avatar-preview-name">User avatar</div>
        </div>
    </div>

    <main class="flex-1 w-full max-w-4xl relative flex flex-col justify-start items-center p-4 min-h-[400px]">
        <!-- Setup Views and Game Area (Same as before) -->
        <div id="setup-area" class="w-full fade-in">
            <div id="view-search" class="w-full flex flex-col gap-6">
                <div class="search-controls flex flex-col sm:flex-row gap-3 sm:gap-4">
                    <div class="flex-1 relative">
                        <input type="text" id="input-artist" placeholder="Artist / Band" class="w-full custom-input p-2 outline-none" data-onkeydown="if(event.key === 'Enter') loadArtistCatalog()">
                        <div id="artist-suggestions" class="search-suggest hidden"></div>
                    </div>
                    <input type="hidden" id="input-title">
                    <div id="title-suggestions" class="search-suggest hidden"></div>
                    <button data-onclick="loadArtistCatalog()" id="btn-fetch-action" class="btn-primary w-full sm:w-auto px-6 py-2 rounded font-bold transition flex items-center justify-center gap-2">
                        <span id="search-btn-text">Load band</span>
                        <div id="search-loader" class="loader hidden"></div>
                    </button>
                </div>
                <div id="search-status-container" class="hidden w-full bg-surface rounded-full h-1 mt-2 overflow-hidden">
                    <div id="search-progress-bar" class="bg-main h-1 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="search-status-text" class="text-main text-xs mt-1 hidden">Initializing...</p>
                <div id="search-error-container" class="hidden mt-4 p-4 bg-surface rounded text-center border border-error">
                    <p id="search-error" class="text-error text-sm font-bold mb-2"></p>
                    <a id="google-fallback-link" href="#" target="_blank" class="text-xs text-base underline hover:text-white">Search on Google</a>
                </div>
                <div id="artist-catalog" class="hidden artist-catalog-wrap">
                    <div class="artist-catalog-head">
                        <div>
                            <div class="text-sub text-xs uppercase">Artist loaded</div>
                            <div id="artist-catalog-name" class="artist-catalog-name">-</div>
                            <div id="artist-catalog-meta" class="artist-catalog-meta">Load a band first, then choose a song.</div>
                        </div>
                    </div>
                    <div class="artist-catalog-filter-row">
                        <input id="artist-song-filter" type="text" class="auth-input" placeholder="Search songs in this band catalog...">
                    </div>
                    <div id="artist-catalog-list" class="artist-songs-list">
                        <div class="auth-recent-empty">Load a band to see songs.</div>
                    </div>
                </div>
            </div>

            <div id="view-presets" class="w-full hidden grid grid-cols-2 gap-4">
                <div id="favorites-tab-list" class="col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="auth-recent-empty">Login to see your saved favorites.</div>
                </div>
            </div>

            <div id="view-custom" class="w-full hidden flex flex-col gap-4">
                <div>
                    <textarea id="custom-text-area" maxlength="4000" class="w-full h-32 bg-surface p-4 rounded text-base outline-none border border-transparent focus:border-main resize-none" placeholder="Paste lyrics here..."></textarea>
                    <div id="custom-text-counter" class="custom-counter">0 / 4000</div>
                </div>
                <div id="custom-translation-container" class="hidden">
                    <textarea id="custom-translation-area" maxlength="4000" class="w-full h-32 bg-surface p-4 rounded text-base outline-none border border-transparent focus:border-main resize-none" placeholder="Paste translation here (optional)..."></textarea>
                    <div id="custom-translation-counter" class="custom-counter">0 / 4000</div>
                </div>
                <label class="auth-checkbox-row">
                    <input id="custom-save-favorite" type="checkbox">
                    <span>Save custom song to favorites (logged users)</span>
                </label>
                <button data-onclick="startCustomGame()" class="self-end btn-primary px-8 py-2 rounded font-bold transition">Start</button>
            </div>
            <div id="view-duel" class="w-full hidden flex flex-col gap-4">
                <div class="duel-view-card">
                    <div class="duel-view-title">Online Duel</div>
                    <div id="duel-step-entry">
                        <div class="duel-view-desc">Create a room or join one.</div>
                        <div class="duel-view-actions mt-3">
                            <button class="auth-submit-btn" data-onclick="createDuelRoomFromCurrentSong()">Create room</button>
                        </div>
                        <div class="auth-friend-add-row mt-2">
                            <input id="duel-room-code-input-view" type="text" class="auth-input" placeholder="Enter room id (uuid)">
                            <button class="auth-submit-btn" data-onclick="joinDuelRoomByCodeFromView()">Join</button>
                        </div>
                    </div>

                    <div id="duel-step-room" class="hidden">
                        <div id="duel-view-state" class="duel-view-state">Not in a duel room.</div>
                        <div id="duel-view-opponent" class="duel-view-opponent"></div>
                        <div class="duel-slots">
                            <div class="duel-slot">
                                <div class="duel-slot-label">Player 1</div>
                                <div id="duel-slot-owner" class="duel-slot-name">-</div>
                            </div>
                            <div class="duel-slot">
                                <div class="duel-slot-label">Player 2</div>
                                <div id="duel-slot-opponent" class="duel-slot-name">Empty slot</div>
                            </div>
                        </div>
                        <div class="auth-friend-add-row mt-2">
                            <input id="duel-view-invite-target" type="text" class="auth-input" placeholder="friend username/email">
                            <button id="duel-view-invite-btn" class="auth-submit-btn" data-onclick="invitePlayerToDuelRoomFromView()">Invite</button>
                        </div>
                        <div class="auth-subtitle mt-3">Invite from friends</div>
                        <div id="duel-view-friend-list" class="auth-friend-list">
                            <div class="auth-recent-empty">No friends added yet.</div>
                        </div>
                        <div class="duel-view-actions">
                            <button id="duel-next-to-song-btn" class="auth-submit-btn" data-onclick="goToDuelSongStep()">Next</button>
                            <button class="auth-friend-btn" data-onclick="leaveCurrentDuelRoom()">Leave room</button>
                        </div>
                    </div>

                    <div id="duel-step-song" class="hidden">
                        <div class="duel-view-state">Choose the song</div>
                        <div class="auth-field-group mt-2">
                            <label class="auth-label" for="duel-song-artist">Artist/Band</label>
                            <input id="duel-song-artist" type="text" class="auth-input" placeholder="Artist/band">
                        </div>
                        <div class="auth-field-group mt-2">
                            <label class="auth-label" for="duel-song-title">Music name</label>
                            <input id="duel-song-title" type="text" class="auth-input" placeholder="Song name">
                        </div>
                        <div id="duel-song-status" class="duel-view-opponent mt-2">Pick a song before starting.</div>
                        <div class="duel-view-actions">
                            <button class="auth-friend-btn" data-onclick="goToDuelRoomStep()">Back</button>
                            <button class="auth-submit-btn" data-onclick="prepareAndStartDuel()">Start Game</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="game-area" class="w-full hidden relative flex flex-col">
            <div id="duel-hud" class="duel-hud hidden">
                <div class="duel-pane">
                    <div class="duel-pane-title">You</div>
                    <div id="duel-me-name" class="duel-pane-name">You</div>
                    <div id="duel-me-progress-text" class="duel-pane-meta">0%</div>
                    <div class="duel-progress-track"><div id="duel-me-progress-bar" class="duel-progress-fill"></div></div>
                </div>
                <div class="duel-center">
                    <div id="duel-countdown-text" class="duel-countdown-text">Waiting...</div>
                </div>
                <div class="duel-pane">
                    <div class="duel-pane-title">Opponent</div>
                    <div id="duel-opponent-name" class="duel-pane-name">-</div>
                    <div id="duel-opponent-progress-text" class="duel-pane-meta">0%</div>
                    <div class="duel-progress-track"><div id="duel-opponent-progress-bar" class="duel-progress-fill"></div></div>
                </div>
            </div>
            <div class="stats-header">
                <div class="flex flex-col justify-end">
                    <h2 id="current-song-title" class="text-3xl font-bold text-main leading-tight">Song Title</h2>
                    <div class="flex items-center gap-4 mt-2">
                        <p id="current-song-artist" class="text-sm text-base opacity-80">Artist</p>
                        <!-- Integrated Toggles -->
                        <div class="flex gap-2 ml-4 border-l border-sub pl-4">
                            <button id="btn-toggle-easy" class="header-toggle-btn" title="Toggle Easy Mode (Translation)" data-onclick="toggleEasyMode()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                            </button>
                            <button id="btn-toggle-speak" class="header-toggle-btn" title="Toggle Auto-Speak" data-onclick="toggleAutoSpeak()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                            </button>
                            <button id="btn-toggle-video" class="header-toggle-btn" title="Toggle Video (PiP)" data-onclick="toggleVideoPanel()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"></rect><path d="M10 9l5 3-5 3z"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="stats-info">
                    <div class="stat-group">
                        <span class="stat-label">Words</span>
                        <div class="stat-value medium">
                            <span id="stats-word-count">0</span><span class="text-sub text-xs" id="stats-total-words">/0</span>
                        </div>
                    </div>
                    <div class="stat-group">
                        <span class="stat-label">C / W</span>
                        <div class="stat-value medium text-success">
                            <span id="live-correct">0</span> <span class="text-sub text-sm">/</span> <span id="live-wrong" class="text-error">0</span>
                        </div>
                    </div>
                    <div class="stat-group">
                        <span class="stat-label">Combo</span>
                        <div id="live-combo" class="stat-value medium text-base">0</div>
                    </div>
                    <div class="stat-group">
                        <span class="stat-label">WPM</span>
                        <div class="stat-value large text-main">
                            <span id="live-wpm">0</span>
                            <span id="live-wpm-diff" class="wpm-diff"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Added pb-32 to ensure enough scroll space at bottom -->
            <div id="words-wrapper" class="relative w-full text-2xl leading-relaxed cursor-text outline-none select-none h-64 overflow-hidden mask-fade-bottom" data-onclick="focusTypingInput()">
                <div id="words" class="absolute top-0 left-0 w-full transition-all duration-200 pb-32">
                    <div id="caret"></div>
                    <!-- Words injected here -->
                </div>
            </div>
            
            <!-- Virtual Keyboard (Visual Only) -->
            <div id="virtual-keyboard">
                <!-- Keys generated here -->
            </div>

            <div class="mt-8 flex justify-center gap-8 text-xs text-sub opacity-70">
                <span><kbd class="bg-surface px-1 rounded">tab</kbd> - restart</span>
                <span><kbd class="bg-surface px-1 rounded">ctrl</kbd> - pronounce word</span>
                <span><kbd class="bg-surface px-1 rounded">alt</kbd> - free look</span>
            </div>
        </div>

        <div id="results-area" class="w-full hidden fade-in flex flex-col">
            <!-- XP Gained Animation -->
            <div class="mb-6 w-full text-center">
                <div class="text-sub text-sm uppercase tracking-widest mb-1">XP Gained</div>
                <div id="xp-gained-display" class="text-4xl font-bold text-main">+0 XP</div>
            </div>

            <div class="flex flex-col md:flex-row gap-8 mb-8 w-full h-64">
                <div class="flex flex-col justify-center gap-6 w-full md:w-1/4">
                    <div>
                        <div class="text-sub text-sm mb-1">wpm</div>
                        <div class="text-6xl font-bold text-main" id="res-wpm-big">0</div>
                    </div>
                    <div>
                        <div class="text-sub text-sm mb-1">acc</div>
                        <div class="text-6xl font-bold text-main" id="res-acc-big">0%</div>
                    </div>
                </div>
                <div class="w-full md:w-3/4 bg-surface rounded-lg p-4 relative border border-sub border-opacity-30">
                    <div id="chart-container"><canvas id="wpm-chart"></canvas></div>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-8 gap-4 mb-8 w-full">
                 <div class="bg-surface p-4 rounded text-center">
                    <div class="dashboard-stat-title">test type</div>
                    <div class="text-base text-lg">lyrics</div>
                    <div class="dashboard-sub-val">english</div>
                </div>
                <div class="bg-surface p-4 rounded text-center">
                    <div class="dashboard-stat-title">raw</div>
                    <div class="dashboard-stat-value" id="res-raw">0</div>
                </div>
                <div class="bg-surface p-4 rounded text-center">
                    <div class="dashboard-stat-title">characters</div>
                    <div class="dashboard-stat-value text-base text-xl">
                        <span id="res-char-total">0</span>/<span class="text-error" id="res-char-err">0</span>
                    </div>
                </div>
                <div class="bg-surface p-4 rounded text-center">
                    <div class="dashboard-stat-title">consistency</div>
                    <div class="dashboard-stat-value" id="res-consistency">0%</div>
                </div>
                 <div class="bg-surface p-4 rounded text-center">
                    <div class="dashboard-stat-title">time</div>
                    <div class="dashboard-stat-value" id="res-time-val">0s</div>
                </div>
                 <div class="bg-surface p-4 rounded text-center">
                    <div class="dashboard-stat-title">cpu finish</div>
                    <div class="dashboard-stat-value text-base text-xl" id="res-cpu-finish">--</div>
                </div>
                 <div class="bg-surface p-4 rounded text-center">
                    <div class="dashboard-stat-title">user finish</div>
                    <div class="dashboard-stat-value text-base text-xl" id="res-user-finish">--</div>
                </div>
                 <div class="bg-surface p-4 rounded text-center">
                    <div class="dashboard-stat-title">delta (you-cpu)</div>
                    <div class="dashboard-stat-value text-base text-xl" id="res-race-diff">--</div>
                </div>
            </div>
             <div id="missed-words-container" class="w-full mb-8 hidden">
                <h3 class="text-sub text-xs uppercase font-bold mb-4 border-b border-sub pb-2">Tricky Words</h3>
                <div id="missed-words-list" class="flex flex-wrap gap-2 mb-4"></div>
                <div class="flex justify-center">
                    <button data-onclick="startPracticeErrors()" class="bg-error text-white px-6 py-2 rounded text-sm hover:opacity-90 transition font-bold shadow-lg">Practice Tricky Words</button>
                </div>
            </div>
            <div class="flex justify-center gap-12 mt-4">
                <button data-onclick="switchTab('search'); goHome()" class="text-sub hover:text-base transition flex items-center gap-2"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 17l-5-5 5-5M18 17l-5-5 5-5"/></svg> Next Song</button>
                <button data-onclick="resetGame(true)" class="text-main hover:text-success transition flex items-center gap-2"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2.5 2v6h6M21.5 22v-6h-6"/><path d="M22 11.5A10 10 0 0 0 3.2 7.2M2 12.5a10 10 0 0 0 18.8 4.2"/></svg> Repeat Test</button>
                <button disabled title="Coming soon" class="text-sub transition flex items-center gap-2 opacity-40 cursor-not-allowed"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="M8.6 13.5l6.8 4M15.4 6.5l-6.8 4"/></svg> Share Score (soon)</button>
            </div>
        </div>
        <div id="shared-result-area" class="w-full hidden fade-in flex flex-col">
            <div class="mb-6 w-full text-center">
                <div class="text-sub text-sm uppercase tracking-widest mb-1">Shared Run</div>
                <div id="shared-result-song" class="text-3xl font-bold text-main">-</div>
                <div id="shared-result-meta" class="text-sub text-sm mt-2">-</div>
                <div class="text-sub text-xs uppercase mt-3">Player</div>
                <div id="shared-result-user" class="text-base font-bold">-</div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 w-full">
                <div class="bg-surface p-4 rounded text-center">
                    <div class="dashboard-stat-title">WPM</div>
                    <div id="shared-result-wpm" class="dashboard-stat-value">0</div>
                </div>
                <div class="bg-surface p-4 rounded text-center">
                    <div class="dashboard-stat-title">ACC</div>
                    <div id="shared-result-acc" class="dashboard-stat-value">0%</div>
                </div>
                <div class="bg-surface p-4 rounded text-center">
                    <div class="dashboard-stat-title">RAW</div>
                    <div id="shared-result-raw" class="dashboard-stat-value">0</div>
                </div>
                <div class="bg-surface p-4 rounded text-center">
                    <div class="dashboard-stat-title">CONSISTENCY</div>
                    <div id="shared-result-consistency" class="dashboard-stat-value">0%</div>
                </div>
            </div>
            <div class="flex justify-center gap-10 mt-2">
                <button data-onclick="closeSharedResultModal()" class="text-sub hover:text-base transition flex items-center gap-2">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 17l-5-5 5-5M18 17l-5-5 5-5"/></svg>
                    Back to app
                </button>
            </div>
        </div>
        <div id="video-pip-panel" class="video-pip-panel hidden">
            <div class="video-pip-header">
                <span id="video-provider-label" class="text-xs uppercase tracking-wide">Spotify</span>
                <button class="video-pip-close" data-onclick="toggleVideoPanel(false)">x</button>
            </div>
            <div class="video-pip-body">
                <a id="video-cover-link" class="video-pip-cover-link" href="#" target="_blank" rel="noopener noreferrer">
                    <img id="video-cover-image" class="video-pip-cover-image" src="" alt="Album cover" loading="lazy">
                    <span id="video-cover-fallback" class="video-pip-cover-fallback">No cover</span>
                </a>
                <a id="video-title-link" class="video-pip-title-link" href="#" target="_blank" rel="noopener noreferrer">Open on Spotify</a>
                <div id="video-subtitle" class="video-pip-subtitle">Search result</div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    
    
    <!-- Main Logic Script -->
    
    <script type="module" src="scripts/main.js"></script>
</body>
</html>
